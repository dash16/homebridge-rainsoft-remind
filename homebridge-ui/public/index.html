<!-- homebridge-ui/public/index.html -->

<div class="text-center mb-3">
	<img
		src="icon.png"
		alt="RainSoft Remind"
		style="width:96px;height:96px;border-radius:5px;"
	/>
</div>

<div class="card mb-3 mt-3">
	<div class="card-body d-flex flex-wrap align-items-center justify-content-between">
		<div>
			<h3 class="card-title mb-1">RainSoft Remind</h3>
			<p class="card-text mb-0">
				Enter your RainSoft account email and password. The plugin will log in and discover your water softener hardware automatically.
			</p>
		</div>
	</div>
</div>

<!-- Credentials / config card -->
<div class="card mb-3">
	<div class="card-body">
		<h5 class="card-title">RainSoft Cloud Credentials</h5>

		<div class="mb-3">
			<label for="rsName" class="form-label">Accessory Name</label>
			<input type="text" id="rsName" class="form-control">
		</div>

		<div class="mb-3">
			<label for="rsEmail" class="form-label">RainSoft Account Email</label>
			<input type="email" id="rsEmail" class="form-control" autocomplete="username">
		</div>

		<div class="mb-3">
			<label for="rsPassword" class="form-label">RainSoft Account Password</label>
			<div class="input-group">
				<input
					type="password"
					id="rsPassword"
					class="form-control"
					autocomplete="current-password"
				>
				<button
					class="btn btn-outline-secondary"
					type="button"
					id="rsPasswordToggle"
				>
					Show
				</button>
			</div>
		</div>
		<small id="rainsoft-status" class="text-muted"></small>
		<button
			id="rainsoft-signout-btn"
			type="button"
			class="btn btn-outline-danger btn-sm mt-2 mt-sm-0"
			style="display: none;"
		>
		Sign out
		</button>
		<div class="mb-3">
			<label for="rsPoll" class="form-label">Polling Interval</label>
			<select id="rsPoll" class="form-select">
				<option value="300">5 minutes</option>
				<option value="1800">30 minutes (default)</option>
				<option value="3600">1 hour</option>
				<option value="43200">12 hours</option>
				<option value="86400">24 hours</option>
			</select>
			<div class="form-text" id="rsPollHelp">
				Polling determines how often the plugin checks RainSoft cloud for updates.
			</div>
		</div>

		<p class="mb-0 text-muted">
			Changes are saved to the plugin configuration immediately. Click
			<strong>Save</strong> in Homebridge to apply them.
		</p>
	</div>
</div>

<!-- Dealer & Regeneration Details -->
<div class="card mb-4">
	<div class="card-header d-flex justify-content-between align-items-center">
		<span>Dealer &amp; Regeneration Details</span>
		<button
			type="button"
			class="btn btn-outline-secondary btn-sm"
			id="rainsoft-info-refresh"
		>
			Refresh
		</button>
	</div>
	<div class="card-body">
		<div id="rainsoft-info-loading" class="text-muted mb-2">
			Loading dealer and regeneration information&hellip;
		</div>

		<div
			id="rainsoft-info-empty"
			class="alert alert-warning mb-0"
			style="display: none;"
		>
			No dealer or regeneration information has been saved yet. It will appear
			here after the plugin successfully fetches identity and status details
			from your RainSoft system.
		</div>

		<div id="rainsoft-info-content" style="display: none;">
			<dl class="row mb-0">
				<dt class="col-sm-3">Dealer</dt>
				<dd class="col-sm-9 text-muted" id="rainsoft-dealer-name">â€”</dd>

				<dt class="col-sm-3">Phone</dt>
				<dd class="col-sm-9 text-muted" id="rainsoft-dealer-phone">â€”</dd>

				<dt class="col-sm-3">Email</dt>
				<dd class="col-sm-9 text-muted" id="rainsoft-dealer-email">â€”</dd>

				<dt class="col-sm-3">Last Regen</dt>
				<dd class="col-sm-9 text-muted" id="rainsoft-last-regen">â€”</dd>

				<dt class="col-sm-3">Snapshot As Of</dt>
				<dd class="col-sm-9 text-muted" id="rainsoft-as-of">â€”</dd>
			</dl>
		</div>
		<div class="card-header">
			Dealer &amp; Regeneration Details
			<small class="text-muted d-block">
				Read-only information fetched from your RainSoft account.
			</small>
		</div>
	</div>
</div>

<script>
function formatDate(value) {
	if (!value) return 'â€”';
	try {
		var d = new Date(value);
		return Number.isNaN(d.getTime()) ? String(value) : d.toLocaleString();
	} catch {
		return 'â€”';
	}
}


// ### ðŸ§© Dealer Contact Link Helpers: make dealer phone/email clickable in the UI
function buildTelHref(raw) {
	if (!raw) return null;
	var cleaned = String(raw).replace(/[^\d+]/g, '');
	return cleaned ? 'tel:' + cleaned : null;
}

function buildMailtoHref(raw) {
	if (!raw) return null;
	var email = String(raw).trim();
	if (!email) return null;
	// Basic sanity check; you already control the source, so keep it light
	if (email.indexOf('@') === -1) return null;
	return 'mailto:' + email;
}

homebridge.addEventListener('ready', async () => {
	// ----- DOM refs -----
	var nameInput = document.getElementById('rsName');
	var emailInput = document.getElementById('rsEmail');
	var passwordInput = document.getElementById('rsPassword');
	var pollSelect = document.getElementById('rsPoll');
	var signOutBtn = document.getElementById('rainsoft-signout-btn');
	var statusEl = document.getElementById('rainsoft-status');
	var passwordToggle = document.getElementById('rsPasswordToggle');
	var pollHelpEl = document.getElementById('rsPollHelp');
	var refreshInfoBtn = document.getElementById('rainsoft-info-refresh');
	
	// Dealer / regen refs
	var loadingEl = document.getElementById('rainsoft-info-loading');
	var emptyEl = document.getElementById('rainsoft-info-empty');
	var contentEl = document.getElementById('rainsoft-info-content');

	var dealerNameEl = document.getElementById('rainsoft-dealer-name');
	var dealerPhoneEl = document.getElementById('rainsoft-dealer-phone');
	var dealerEmailEl = document.getElementById('rainsoft-dealer-email');
	var lastRegenEl = document.getElementById('rainsoft-last-regen');
	var asOfEl = document.getElementById('rainsoft-as-of');

	// ----- Config wiring -----
	var pluginConfig = await homebridge.getPluginConfig();
	var cfg = pluginConfig[0] || {};
	
	if (passwordToggle && passwordInput) {
		passwordToggle.addEventListener('click', function () {
			var isPassword = passwordInput.type === 'password';
			passwordInput.type = isPassword ? 'text' : 'password';
			passwordToggle.textContent = isPassword ? 'Hide' : 'Show';
		});
	}
	function setStatus(text, type) {
		if (!statusEl) return;
		statusEl.textContent = text || '';
		statusEl.className = 'text-muted';
	
		// Optional: color hint based on state
		if (type === 'ok') {
			statusEl.classList.add('text-success');
		} else if (type === 'warn') {
			statusEl.classList.add('text-warning');
		} else if (type === 'error') {
			statusEl.classList.add('text-danger');
		}
	}

	function setLockedState(locked) {
		if (emailInput) {
			emailInput.disabled = locked;
			emailInput.readOnly = locked;
		}
		if (passwordInput) {
			passwordInput.disabled = locked;
			passwordInput.readOnly = locked;
	
			// When locking, force the field back to password type
			if (locked) {
				passwordInput.type = 'password';
			}
		}
	
		// Show/Hide + disable the toggle button in sync
		if (passwordToggle) {
			if (locked) {
				passwordToggle.disabled = true;
				passwordToggle.style.visibility = 'hidden';
				passwordToggle.textContent = 'Show'; // reset label
			} else {
				passwordToggle.disabled = false;
				passwordToggle.style.visibility = 'visible';
			}
		}
		// poll interval and name remain editable
	}
	function updatePollHelp(seconds) {
		if (!pollHelpEl) return;
	
		var label;
		if (seconds <= 300) {
			label = 'High update frequency; more API calls.';
		} else if (seconds <= 3600) {
			label = 'Balanced updates; recommended for most users.';
		} else {
			label = 'Low update frequency; fewer API calls, slower updates.';
		}
	
		pollHelpEl.textContent =
			'Currently set to ' + Math.round(seconds / 60) + ' minutes. ' + label;
	}
	async function updateConfig(partial) {
		cfg = Object.assign({}, cfg, partial);
		pluginConfig = [cfg];
		await homebridge.updatePluginConfig(pluginConfig);
	}

	// Load from config.json into UI
	if (nameInput) {
		nameInput.value = cfg.name || 'RainSoft';
	}
	if (emailInput) {
		emailInput.value = cfg.email || '';
	}
	if (passwordInput) {
		passwordInput.value = cfg.password || '';
	}
	if (pollSelect) {
		var currentPoll = cfg.pollSeconds || 1800;
		// If currentPoll isn't one of the options, leave selection alone but keep value
		if (Array.prototype.some.call(pollSelect.options, function (opt) {
			return String(opt.value) === String(currentPoll);
		})) {
			pollSelect.value = String(currentPoll);
		} else {
			pollSelect.value = '1800';
		}
		updatePollHelp(currentPoll);
	}

	// Listen for changes and write back to config
	if (nameInput) {
		nameInput.addEventListener('change', function () {
			updateConfig({ name: nameInput.value || 'RainSoft' })
				.catch(function (e) {
					console.error('[rainsoft-ui] failed to update name:', e);
				});
		});
	}

	if (emailInput) {
		emailInput.addEventListener('change', function () {
			var value = emailInput.value.trim();
			var normalized = value.toLowerCase();
			emailInput.value = normalized;
			updateConfig({ email: normalized })
				.catch(function (e) {
					console.error('[rainsoft-ui] failed to update email:', e);
				});
		});
	}

	if (passwordInput) {
		passwordInput.addEventListener('change', function () {
			updateConfig({ password: passwordInput.value })
				.catch(function (e) {
					console.error('[rainsoft-ui] failed to update password:', e);
				});
		});
	}

	if (pollSelect) {
		pollSelect.addEventListener('change', function () {
			var seconds = parseInt(pollSelect.value, 10);
			if (!seconds || seconds < 60) {
				seconds = 1800;
			}
			updateConfig({ pollSeconds: seconds })
				.catch(function (e) {
					console.error('[rainsoft-ui] failed to update pollSeconds:', e);
				});
			updatePollHelp(seconds);	
		});
	}

	// ----- Auth state / Sign out (using identity.json) -----

	async function refreshAuthState() {
		try {
			var state = await homebridge.request('/rainsoft/auth-state', {});
			var hasIdentity = !!(state && state.hasIdentity);

			setLockedState(hasIdentity);

			if (signOutBtn) {
				signOutBtn.style.display = hasIdentity ? '' : 'none';
			}

			if (statusEl) {
				if (hasIdentity) {
					var label = cfg.email || 'RainSoft account';
					setStatus('Signed in as ' + label + '.', 'ok');
				} else {
					setStatus('Not signed in. Enter credentials and click Save in Homebridge.', 'warn');
				}
			}
		} catch (err) {
			console.error('[rainsoft-ui] /rainsoft/auth-state error:', err);
			setLockedState(false);
			if (signOutBtn) {
				signOutBtn.style.display = 'none';
			}
			if (statusEl) {
				setStatus('Unable to determine sign-in state.', 'error');
			}
		}
	}

	if (signOutBtn) {
		signOutBtn.addEventListener('click', async function () {
			try {
				await homebridge.request('/rainsoft/signout', {});
				homebridge.toast.success(
					'Signed out. You can now change your RainSoft credentials.',
					'RainSoft Remind'
				);

				// Unlock fields; keep current values so user can edit/change them
				setLockedState(false);
				if (signOutBtn) {
					signOutBtn.style.display = 'none';
				}
				if (statusEl) {
					statusEl.textContent = 'Signed out. Click Save in Homebridge to apply changes.';
				}
			} catch (err) {
				console.error('[rainsoft-ui] /rainsoft/signout error:', err);
				homebridge.toast.error(
					'Failed to sign out. See logs for details.',
					'RainSoft Remind'
				);
			}
		});
	}

	// Initial auth-state check
	refreshAuthState();

	// ----- Dealer / regen info wiring -----
	async function loadDealerInfo() {
		var info;
		try {
			info = await homebridge.request('/rainsoft/info', {});
		} catch (err) {
			console.error('[rainsoft-remind][ui] /rainsoft/info error:', err);
			if (loadingEl) {
				loadingEl.textContent =
					'Failed to load dealer/regeneration information.';
			}
			homebridge.toast.error(
				'Failed to load dealer/regeneration information.',
				'RainSoft Remind'
			);
			return;
		}
	
		if (loadingEl) {
			loadingEl.style.display = 'none';
		}
	
		if (!info) {
			if (emptyEl) emptyEl.style.display = '';
			return;
		}
	
		var hasDealer =
			info.dealerName || info.dealerPhone || info.dealerEmail;
		var hasRegen = info.lastRegenDate || info.asOf;
	
		if (!hasDealer && !hasRegen) {
			if (emptyEl) emptyEl.style.display = '';
			return;
		}
	
		if (dealerNameEl) {
			dealerNameEl.textContent = info.dealerName || 'â€”';
		}
	
		if (dealerPhoneEl) {
			if (info.dealerPhone) {
				var telHref = buildTelHref(info.dealerPhone);
				if (telHref) {
					dealerPhoneEl.innerHTML =
						'<a href="' + telHref + '">' + info.dealerPhone + '</a>';
				} else {
					dealerPhoneEl.textContent = info.dealerPhone;
				}
			} else {
				dealerPhoneEl.textContent = 'â€”';
			}
		}
	
		if (dealerEmailEl) {
			if (info.dealerEmail) {
				var mailHref = buildMailtoHref(info.dealerEmail);
				if (mailHref) {
					var safeEmail = String(info.dealerEmail).trim();
					dealerEmailEl.innerHTML =
						'<a href="' + mailHref + '">' + safeEmail + '</a>';
				} else {
					dealerEmailEl.textContent = info.dealerEmail;
				}
			} else {
				dealerEmailEl.textContent = 'â€”';
			}
		}
	
		if (lastRegenEl) {
			var last = formatDate(info.lastRegenDate);
			lastRegenEl.innerHTML = last === 'â€”'
				? 'â€”'
				: '<small>' + last + '</small>';
		}
	
		if (asOfEl) {
			var asOf = formatDate(info.asOf);
			asOfEl.innerHTML = asOf === 'â€”'
				? 'â€”'
				: '<small>' + asOf + '</small>';
		}
	
		if (contentEl) contentEl.style.display = '';
		if (emptyEl) emptyEl.style.display = 'none';
	}
	
	if (refreshInfoBtn) {
		refreshInfoBtn.addEventListener('click', function () {
			homebridge.toast.info(
				'Refreshing dealer/regeneration detailsâ€¦',
				'RainSoft Remind'
			);
			loadDealerInfo();
		});
	}
	
	// Initial load
	await loadDealerInfo();
});

</script>
